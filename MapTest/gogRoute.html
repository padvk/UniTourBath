<!DOCTYPE html >
  <head>
    <title>UniTour Bath</title>
    <style>
      /* Height of map must be set explicitly */
      #map {
        height: 100%;
      }
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <script>
		console.log("First call");
		var customLabel = {
			poi: {
				label: 'P'
			},
			visited: {
			label: 'V'
			}
		};
	  
		var map;
		
		//Initialises map. Centred about bath uni.
		function initMap() {
			
			map = new google.maps.Map(document.getElementById('map'), {
				center: new google.maps.LatLng(51.379193, -2.327405),
				zoom: 16
			});
			var infoWindow = new google.maps.InfoWindow;
			var latiLong = new Array();
				
			console.log("Download URL function");
			//URL for XML file
			//Takes information from XML file and adds markers to map
			downloadUrl('pointsOfInterest.xml', function(data) {
				var xml = data.responseXML;
				var pointsOfInterest = xml.documentElement.getElementsByTagName('marker');
				Array.prototype.forEach.call(pointsOfInterest, function(markerElem) {
					var name = markerElem.getAttribute('name');
					var address = markerElem.getAttribute('address');
					var type = markerElem.getAttribute('type');
					var point = new google.maps.LatLng(
						parseFloat(markerElem.getAttribute('lat')),
						parseFloat(markerElem.getAttribute('lng'))
					);
						
					//pushing the point (lat and long data) to latiLong - used for the route finding
					latiLong.push(point);
					
					var infowincontent = document.createElement('div');
					var strong = document.createElement('strong');
					strong.textContent = name
					infowincontent.appendChild(strong);
					infowincontent.appendChild(document.createElement('br'));

					var text = document.createElement('text');
					text.textContent = address
					infowincontent.appendChild(text);
					var icon = customLabel[type] || {};
					var marker = new google.maps.Marker({
					map: map,
					position: point,
					label: icon.label
					});
					marker.addListener('click', function() {
					infoWindow.setContent(infowincontent);
					infoWindow.open(map, marker);
					
					});
				});
				calculateRoute(latiLong);
			});
		}

		//Function to read in XML file
		function downloadUrl(url, callback) {
			var request = window.ActiveXObject ?
				new ActiveXObject('Microsoft.XMLHTTP') :
				new XMLHttpRequest;

			request.onreadystatechange = function() {
			  if (request.readyState == 4) {
				request.onreadystatechange = doNothing;
				callback(request, request.status);
			  }
			};

			request.open('GET', url, true);
			request.send(null);
		}
		  
		  
		//calculate route uses the array latiLong that stores the lat and long of the points. 
		//It loops through each point and draws routes for each one
		function calculateRoute(latiLong) {
			
			//Create Path array
			var path = new google.maps.MVCArray();
			
			//Initialise Google's direction service
			var service = new google.maps.DirectionsService();
			
			//Set path colour
			var poly = new google.maps.Polyline({ strokeColor: '#CC00FF' });
			poly.setMap(map);
			
			//Draw route
			for (var i = 0; i <= latiLong.length; i++) {
				if ((i+1) < latiLong.length) {
					var src = latiLong[i];
					var des = latiLong[i+1];
					poly.setPath(path);
					service.route({
						origin: src,
						destination: des,
						travelMode: google.maps.DirectionsTravelMode.WALKING
					}, function (result, status) {
						if (status == 'OK') {
							for (var i = 0, len = result.routes[0].overview_path.length; i < len; i++) {
								path.push(result.routes[0].overview_path[i]);
							}
						}
					});
				}
			}
		}
		  
		function doNothing() {}
	  
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBdds_EpEfCnpojHMvMUvntJj1gCx9moOA&callback=initMap">
    </script>

  </body>
</html>
